---
name: Lighthouse
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
jobs:
  lhci:
    name: Lighthouse
    environment: scalingo-recette
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version:
          - 18.x
    steps:
      - uses: actions/checkout@v3
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
          cache: npm
      - run: echo $NEXT_PUBLIC_SENTRY_DSN -n | base64 && npm ci
      - name: Start dev
        run: |
          nohup npm run dev &
      - name: Sleep for 5 seconds
        run: sleep 5s
        shell: bash
      - name: Install Lighthouse CI
        run: npm install -g @lhci/cli@0.12.x
      - name: Run Lighthouse CI
        run: curl http://localhost:3000 && lhci autorun
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
          ENVIRONMENT: ${{ vars.ENVIRONMENT }}
          IS_REVIEW_APP: ${{ vars.IS_REVIEW_APP }}
          NEXT_TELEMETRY_DISABLED: ${{ vars.NEXT_TELEMETRY_DISABLED }}
          NODE_MODULES_CACHE: ${{ vars.NODE_MODULES_CACHE }}
          SENTRY_DSN: ${{ vars.SENTRY_DSN }}
          SENTRY_ENVIRONMENT: ${{ vars.ENVIRONMENT }}
          SENTRY_ORG: ${{ vars.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ vars.SENTRY_PROJECT }}
          SENTRY_TRACES_SAMPLE_RATE: ${{ vars.SENTRY_TRACES_SAMPLE_RATE }}
          SENTRY_URL: ${{ vars.SENTRY_URL }}
          SENTRY_USER_AGENT_BLACKLIST: ${{ vars.SENTRY_USER_AGENT_BLACKLIST }}
          NEXT_PUBLIC_ALTERNANCE_LBA_FEATURE: ${{ vars.NEXT_PUBLIC_ALTERNANCE_LBA_FEATURE }}
          NEXT_PUBLIC_ANALYTICS_DOMAIN: ${{ vars.NEXT_PUBLIC_ANALYTICS_DOMAIN }}
          NEXT_PUBLIC_ANALYTICS_ENVIRONMENT: ${{ vars.NEXT_PUBLIC_ANALYTICS_ENVIRONMENT }}
          NEXT_PUBLIC_ANALYTICS_EULERIAN_FEATURE: ${{ vars.NEXT_PUBLIC_ANALYTICS_EULERIAN_FEATURE }}
          NEXT_PUBLIC_API_ADRESSE_MINIMUM_QUERY_LENGTH: ${{ vars.NEXT_PUBLIC_API_ADRESSE_MINIMUM_QUERY_LENGTH }}
          NEXT_PUBLIC_CAMPAGNE_APPRENTISSAGE_FEATURE: ${{ vars.NEXT_PUBLIC_CAMPAGNE_APPRENTISSAGE_FEATURE }}
          NEXT_PUBLIC_DEPOT_STAGE_FEATURE: ${{ vars.NEXT_PUBLIC_DEPOT_STAGE_FEATURE }}
          NEXT_PUBLIC_ENQUETE_SATISFACTION_FEATURE: ${{ vars.NEXT_PUBLIC_ENQUETE_SATISFACTION_FEATURE }}
          NEXT_PUBLIC_ENQUETE_SATISFACTION_URL: ${{ vars.NEXT_PUBLIC_ENQUETE_SATISFACTION_URL }}
          NEXT_PUBLIC_FAQ_FEATURE: ${{ vars.NEXT_PUBLIC_FAQ_FEATURE }}
          NEXT_PUBLIC_FORMATION_LBA_FEATURE: ${{ vars.NEXT_PUBLIC_FORMATION_LBA_FEATURE }}
          NEXT_PUBLIC_INDEX_ANNONCE_DE_LOGEMENT: ${{ vars.NEXT_PUBLIC_INDEX_ANNONCE_DE_LOGEMENT }}
          NEXT_PUBLIC_INDEX_OFFRE_DE_STAGE: ${{ vars.NEXT_PUBLIC_INDEX_OFFRE_DE_STAGE }}
          NEXT_PUBLIC_JOB_ETE_FEATURE: ${{ vars.NEXT_PUBLIC_JOB_ETE_FEATURE }}
          NEXT_PUBLIC_LA_BONNE_ALTERNANCE_URL: ${{ vars.NEXT_PUBLIC_LA_BONNE_ALTERNANCE_URL }}
          NEXT_PUBLIC_LOGEMENT_FEATURE: ${{ vars.NEXT_PUBLIC_LOGEMENT_FEATURE }}
          NEXT_PUBLIC_RECHERCHE_EVENEMENT_FEATURE: ${{ vars.NEXT_PUBLIC_RECHERCHE_EVENEMENT_FEATURE }}
          NEXT_PUBLIC_SENTRY_DSN: ${{ vars.SENTRY_DSN }}
          NEXT_PUBLIC_SENTRY_ENVIRONMENT: ${{ vars.SENTRY_ENVIRONMENT }}
          NEXT_PUBLIC_SENTRY_LOG_LEVEL: ${{ vars.NEXT_PUBLIC_SENTRY_LOG_LEVEL }}
          NEXT_PUBLIC_SENTRY_TRACES_SAMPLE_RATE: ${{ vars.SENTRY_TRACES_SAMPLE_RATE }}
          NEXT_PUBLIC_SENTRY_USER_AGENT_BLACKLIST: ${{ vars.NEXT_PUBLIC_SENTRY_USER_AGENT_BLACKLIST }}
          NEXT_PUBLIC_STAGE_SEARCH_ENGINE_API_KEY: ${{ vars.NEXT_PUBLIC_STAGE_SEARCH_ENGINE_API_KEY }}
          NEXT_PUBLIC_STAGE_SEARCH_ENGINE_BASE_URL: ${{ vars.NEXT_PUBLIC_STAGE_SEARCH_ENGINE_BASE_URL }}
          API_POLE_EMPLOI_FEATURE: ${{ vars.API_POLE_EMPLOI_FEATURE }}
          API_ADRESSE_BASE_URL: ${{ secrets.API_ADRESSE_BASE_URL }}
          API_ENGAGEMENT_API_KEY_TOKEN: ${{ secrets.API_ENGAGEMENT_API_KEY_TOKEN }}
          API_ENGAGEMENT_BASE_URL: ${{ secrets.API_ENGAGEMENT_BASE_URL }}
          API_ETABLISSEMENTS_PUBLICS: ${{ secrets.API_ETABLISSEMENTS_PUBLICS }}
          API_GEO_BASE_URL: ${{ secrets.API_GEO_BASE_URL }}
          API_LA_BONNE_ALTERNANCE_CALLER: ${{ secrets.API_LA_BONNE_ALTERNANCE_CALLER }}
          API_LA_BONNE_ALTERNANCE_URL: ${{ secrets.API_LA_BONNE_ALTERNANCE_URL }}
          API_LES_ENTREPRISES_SENGAGENT_URL: ${{ secrets.API_LES_ENTREPRISES_SENGAGENT_URL }}
          API_POLE_EMPLOI_OFFRES_URL: ${{ secrets.API_POLE_EMPLOI_OFFRES_URL }}
          API_POLE_EMPLOI_REFERENTIEL_URL: ${{ secrets.API_POLE_EMPLOI_REFERENTIEL_URL }}
          API_TRAJECTOIRES_PRO_URL: ${{ secrets.API_TRAJECTOIRES_PRO_URL }}
          BUCKET_S3_URL: ${{ secrets.BUCKET_S3_URL }}
          LOGEMENT_IMAGE_URL_LIST: ${{ secrets.LOGEMENT_IMAGE_URL_LIST }}
          MAILER_SERVICE_ACTIVE: ${{ secrets.MAILER_SERVICE_ACTIVE }}
          MAILER_SERVICE_REDIRECT_TO: ${{ secrets.MAILER_SERVICE_REDIRECT_TO }}
          POLE_EMPLOI_CONNECT_CLIENT_ID: ${{ secrets.POLE_EMPLOI_CONNECT_CLIENT_ID }}
          POLE_EMPLOI_CONNECT_CLIENT_SECRET: ${{ secrets.POLE_EMPLOI_CONNECT_CLIENT_SECRET }}
          POLE_EMPLOI_CONNECT_SCOPE: ${{ secrets.POLE_EMPLOI_CONNECT_SCOPE }}
          POLE_EMPLOI_CONNECT_URL: ${{ secrets.POLE_EMPLOI_CONNECT_URL }}
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          STRAPI_AUTH: ${{ secrets.STRAPI_AUTH }}
          STRAPI_BASE_URL: ${{ secrets.STRAPI_BASE_URL }}
          STRAPI_MEDIA_URL: "https://url-test.com"
          STRAPI_URL_API: ${{ secrets.STRAPI_URL_API }}
          TIPIMAIL_API_BASE_URL: ${{ secrets.TIPIMAIL_API_BASE_URL }}
          TIPIMAIL_API_KEY: ${{ secrets.TIPIMAIL_API_KEY }}
          TIPIMAIL_API_USER: ${{ secrets.TIPIMAIL_API_USER }}
